desc: 動的なループ制御
runners:
  httpbin: http://localhost:8080

vars:
  items_to_process:
    - id: 1
      name: "Item 1"
      active: true
    - id: 2
      name: "Item 2"
      active: false
    - id: 3
      name: "Item 3"
      active: true

steps:
  # HTTPBinのanythingエンドポイントでページネーションをシミュレート
  - desc: ページネーションのシミュレーション
    loop:
      count: 3
      until: i >= 2  # 3回目で終了
    httpbin:
      /anything:
        get:
          query:
            page: "{{ i + 1 }}"
            limit: "10"
          body:
    test: current.res.status == 200
    dump: |
      {
        "page": i + 1,
        "has_more": i < 2
      }

  # 条件に基づく動的ループ
  - desc: アクティブなアイテムのみ処理
    loop:
      count: len(vars.items_to_process)
    if: vars.items_to_process[i].active
    httpbin:
      /post:
        post:
          body:
            application/json:
              item_id: "{{ vars.items_to_process[i].id }}"
              item_name: "{{ vars.items_to_process[i].name }}"
    test: |
      current.res.status == 200 &&
      current.res.body.json.item_id == vars.items_to_process[i].id